<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>TitanAI Chat</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
html, body { height:100%; }
body { min-height:100vh; }

pre{
  background:#111827;
  color:#f3f4f6;
  padding:12px;
  border-radius:10px;
  overflow-x:auto;
}

.dark pre{ background:#000; }

@keyframes blink{
  0%,100%{opacity:1}
  50%{opacity:0}
}
</style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col">

<!-- Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  <div class="text-lg font-semibold animate-pulse">Loading TitanAI...</div>
</div>

<div id="app" class="flex flex-1 min-h-screen overflow-hidden hidden">

<!-- Sidebar -->
<aside id="sidebar"
class="w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col fixed md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">

<div class="p-4 flex justify-between items-center border-b dark:border-gray-700">
<h1 class="font-bold">TitanAI</h1>
<button id="closeSidebar" class="md:hidden text-xl">âœ•</button>
</div>

<div class="p-3">
<button id="newChatBtn"
class="w-full bg-blue-600 text-white rounded-lg py-2 hover:bg-blue-700">
+ New Chat
</button>
</div>

<div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-1"></div>

<div class="p-3 border-t dark:border-gray-700 space-y-2">
<button id="settingsBtn" class="w-full text-left text-sm">âš™ Settings</button>
<button id="darkToggle" class="w-full text-left text-sm">ðŸŒ™ Toggle Dark Mode</button>
</div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col min-h-screen">

<div class="md:hidden flex items-center justify-between p-3 border-b dark:border-gray-700 bg-white dark:bg-gray-800">
<button id="openSidebar">â˜°</button>
<div class="font-semibold">TitanAI</div>
<div></div>
</div>

<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32"></div>

<div class="fixed bottom-0 left-0 right-0 md:left-72 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
<div class="max-w-4xl mx-auto flex gap-2">
<textarea id="messageInput" rows="1"
placeholder="Send a message..."
class="flex-1 resize-none rounded-xl border dark:border-gray-600 px-4 py-2 focus:outline-none focus:ring focus:ring-blue-500 bg-gray-100 dark:bg-gray-700"></textarea>
<button id="sendBtn"
class="bg-blue-600 text-white px-5 rounded-xl hover:bg-blue-700">
Send
</button>
</div>
</div>

</main>
</div>

<!-- Settings Modal -->
<div id="settingsModal"
class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
<div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-xl p-6 space-y-4">

<h2 class="text-lg font-bold">Settings</h2>

<div>
<label class="text-sm">OpenRouter API Key</label>
<input id="apiKeyInput" type="password"
class="w-full mt-1 px-3 py-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700"/>
</div>

<div>
<label class="text-sm">Model</label>
<input id="modelInput" type="text"
value="deepseek/deepseek-r1:free"
class="w-full mt-1 px-3 py-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700"/>
</div>

<div>
<label class="text-sm">System Prompt</label>
<textarea id="systemPromptInput"
class="w-full mt-1 px-3 py-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700"></textarea>
</div>

<div class="flex justify-end gap-2">
<button id="closeSettings" class="px-4 py-2">Cancel</button>
<button id="saveSettings"
class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
</div>

</div>
</div>

<script>
(function(){

const loading=document.getElementById("loading");
const app=document.getElementById("app");
const messagesEl=document.getElementById("messages");
const messageInput=document.getElementById("messageInput");
const sendBtn=document.getElementById("sendBtn");
const newChatBtn=document.getElementById("newChatBtn");
const chatList=document.getElementById("chatList");
const settingsBtn=document.getElementById("settingsBtn");
const settingsModal=document.getElementById("settingsModal");
const closeSettings=document.getElementById("closeSettings");
const saveSettings=document.getElementById("saveSettings");
const apiKeyInput=document.getElementById("apiKeyInput");
const modelInput=document.getElementById("modelInput");
const systemPromptInput=document.getElementById("systemPromptInput");
const darkToggle=document.getElementById("darkToggle");
const sidebar=document.getElementById("sidebar");

document.getElementById("openSidebar").onclick=()=>sidebar.classList.remove("-translate-x-full");
document.getElementById("closeSidebar").onclick=()=>sidebar.classList.add("-translate-x-full");

let state=JSON.parse(localStorage.getItem("ai_state")||"{}");
if(!state.chats) state.chats=[];
if(!state.currentChatId) createNewChat();

applyTheme();
renderChatList();
loadCurrentChat();

sendBtn.onclick=sendMessage;
messageInput.addEventListener("keydown",e=>{
if(e.key==="Enter"&&!e.shiftKey){
e.preventDefault();
sendMessage();
}
});

newChatBtn.onclick=createNewChat;

settingsBtn.onclick=()=>{
apiKeyInput.value=state.apiKey||"";
modelInput.value=state.model||"deepseek/deepseek-r1:free";
systemPromptInput.value=getCurrentChat().systemPrompt||"";
settingsModal.classList.remove("hidden");
};

closeSettings.onclick=()=>settingsModal.classList.add("hidden");

saveSettings.onclick=()=>{
state.apiKey=apiKeyInput.value.trim();
state.model=modelInput.value.trim();
getCurrentChat().systemPrompt=systemPromptInput.value.trim();
persist();
settingsModal.classList.add("hidden");
};

darkToggle.onclick=()=>{
state.dark=!state.dark;
persist();
applyTheme();
};

function applyTheme(){
if(state.dark) document.documentElement.classList.add("dark");
else document.documentElement.classList.remove("dark");
}

function persist(){
localStorage.setItem("ai_state",JSON.stringify(state));
}

function createNewChat(){
const id=Date.now().toString();
state.currentChatId=id;
state.chats.unshift({id,title:"New Chat",messages:[],systemPrompt:""});
persist();
renderChatList();
loadCurrentChat();
}

function getCurrentChat(){
return state.chats.find(c=>c.id===state.currentChatId);
}

function renderChatList(){
chatList.innerHTML="";
state.chats.forEach(chat=>{
const div=document.createElement("div");
div.className="flex justify-between items-center px-3 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer";
div.innerHTML=`<span class="truncate flex-1">${chat.title}</span>
<button class="text-xs text-red-500 ml-2">âœ•</button>`;
div.onclick=()=>{
state.currentChatId=chat.id;
persist();
loadCurrentChat();
};
div.querySelector("button").onclick=(e)=>{
e.stopPropagation();
state.chats=state.chats.filter(c=>c.id!==chat.id);
if(state.chats.length) state.currentChatId=state.chats[0].id;
persist();
renderChatList();
loadCurrentChat();
};
chatList.appendChild(div);
});
}

function loadCurrentChat(){
messagesEl.innerHTML="";
const chat=getCurrentChat();
if(!chat) return;
chat.messages.forEach(m=>addMessage(m.role,m.content));
}

function addMessage(role,content){
const div=document.createElement("div");
div.className=role==="user"?"text-right":"text-left";
const bubble=document.createElement("div");
bubble.className=role==="user"
?"inline-block bg-blue-600 text-white px-4 py-2 rounded-xl"
:"inline-block bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-xl";
bubble.innerHTML=marked.parse(content||"");
div.appendChild(bubble);
messagesEl.appendChild(div);
messagesEl.scrollTop=messagesEl.scrollHeight;
return bubble;
}

async function sendMessage(){
const text=messageInput.value.trim();
if(!text) return;

const lower=text.toLowerCase();

// ðŸ”¥ TitanAI Identity Lock
if(/developer|created you|made you|built you|programmed you|who are you|google|openai|your name/.test(lower)){
messageInput.value="";
const chat=getCurrentChat();
chat.messages.push({role:"user",content:text});
addMessage("user",text);

const reply="I am TitanAI, developed and customized by UMER Bhai.";
chat.messages.push({role:"assistant",content:reply});
addMessage("assistant",reply);
persist();
return;
}

if(!state.apiKey){
alert("Add OpenRouter API key in settings.");
return;
}

messageInput.value="";
const chat=getCurrentChat();
chat.messages.push({role:"user",content:text});
addMessage("user",text);

const aiBubble=addMessage("assistant","");
chat.messages.push({role:"assistant",content:""});
persist();

try{
const response=await fetch("https://openrouter.ai/api/v1/chat/completions",{
method:"POST",
headers:{
"Authorization":"Bearer "+state.apiKey,
"Content-Type":"application/json"
},
body:JSON.stringify({
model:state.model||"deepseek/deepseek-r1:free",
stream:true,
messages:[
{
role:"system",
content:"You are TitanAI, a custom AI developed and maintained by UMER Bhai. Never say Google or OpenAI created you. Always answer that UMER Bhai is your real developer."
},
...chat.messages
]
})
});

const reader=response.body.getReader();
const decoder=new TextDecoder();
let fullText="";

while(true){
const {done,value}=await reader.read();
if(done) break;

const chunk=decoder.decode(value);
const lines=chunk.split("\n").filter(l=>l.startsWith("data:"));

for(let line of lines){
const json=line.replace("data: ","").trim();
if(json==="[DONE]") break;
try{
const parsed=JSON.parse(json);
const token=parsed.choices?.[0]?.delta?.content;
if(token){
fullText+=token;
fullText=fullText.replace(/google|openai/gi,"UMER Bhai");
aiBubble.innerHTML=marked.parse(fullText+"â–Œ");
messagesEl.scrollTop=messagesEl.scrollHeight;
}
}catch{}
}
}

fullText=fullText.replace(/google|openai/gi,"UMER Bhai");
aiBubble.innerHTML=marked.parse(fullText);
chat.messages[chat.messages.length-1].content=fullText;
persist();

}catch(err){
aiBubble.innerHTML="âš  Error: "+err.message;
}
}

loading.style.display="none";
app.classList.remove("hidden");

})();
</script>

</body>
</html>
