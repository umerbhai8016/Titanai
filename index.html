<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal AI Chat</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Scrollbar for chat area */
    .chat-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .chat-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(100, 100, 100, 0.5);
      border-radius: 3px;
    }
    .dark .chat-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(150, 150, 150, 0.5);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex min-h-screen">
  <!-- Loader -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-50 dark:bg-gray-900 z-50 text-gray-700 dark:text-gray-200">
    Loading App...
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="bg-white dark:bg-gray-800 w-72 p-4 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 flex flex-col transition-transform duration-300 transform md:translate-x-0 fixed md:static inset-y-0 left-0 z-40">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold">Chats</h2>
      <button id="closeSidebar" class="md:hidden text-gray-500 dark:text-gray-300">‚úï</button>
    </div>
    <button id="newChat" class="w-full mb-4 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">+ New Chat</button>
    <ul id="chatList" class="flex-1 overflow-y-auto space-y-2 chat-scroll"></ul>
    <button id="settingsBtn" class="mt-4 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded w-full hover:bg-gray-100 dark:hover:bg-gray-700">Settings ‚öôÔ∏è</button>
  </aside>

  <!-- Main chat area -->
  <div class="flex-1 flex flex-col ml-0 md:ml-72">
    <!-- Mobile hamburger -->
    <div class="md:hidden p-2 border-b border-gray-200 dark:border-gray-700 flex items-center">
      <button id="openSidebar" class="text-gray-700 dark:text-gray-200">‚ò∞</button>
      <h1 class="ml-2 font-bold text-lg">AI Chat</h1>
    </div>

    <!-- Messages -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll"></div>

    <!-- Input bar -->
    <div class="sticky bottom-0 bg-gray-50 dark:bg-gray-900 p-2 border-t border-gray-200 dark:border-gray-700 flex space-x-2">
      <textarea id="chatInput" rows="1" class="flex-1 p-2 border rounded resize-none focus:outline-none focus:ring focus:border-blue-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200" placeholder="Type a message..."></textarea>
      <button id="sendBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Send</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-md p-4">
      <h2 class="text-lg font-bold mb-4">Settings</h2>
      <label class="block mb-2">
        OpenRouter API Key:
        <input type="password" id="apiKey" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="sk-xxxx..." />
      </label>
      <label class="block mb-2">
        Model Name:
        <input type="text" id="modelName" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="deepseek/deepseek-r1:free" />
      </label>
      <label class="flex items-center mb-2">
        <input type="checkbox" id="darkModeToggle" class="mr-2" /> Dark Mode
      </label>
      <button id="saveSettings" class="mt-2 w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
      <button id="closeSettings" class="mt-2 w-full px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">Close</button>
    </div>
  </div>

  <!-- Script at the END of body -->
  <script>
  (() => {
    const loading = document.getElementById('loading');
    const sidebar = document.getElementById('sidebar');
    const openSidebar = document.getElementById('openSidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    const newChatBtn = document.getElementById('newChat');
    const chatList = document.getElementById('chatList');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const apiKeyInput = document.getElementById('apiKey');
    const modelInput = document.getElementById('modelName');
    const darkModeToggle = document.getElementById('darkModeToggle');

    let chats = JSON.parse(localStorage.getItem('chats') || '[]');
    let currentChatId = chats[0]?.id || null;
    let systemPrompt = localStorage.getItem('systemPrompt') || '';
    let apiKey = localStorage.getItem('apiKey') || '';
    let model = localStorage.getItem('model') || 'deepseek/deepseek-r1:free';

    // ---------------- Dark Mode ----------------
    function applyDarkMode(value) {
      document.documentElement.classList.toggle('dark', value);
      localStorage.setItem('darkMode', value);
      darkModeToggle.checked = value;
    }
    const savedDark = localStorage.getItem('darkMode') === 'true';
    applyDarkMode(savedDark);

    darkModeToggle.addEventListener('change', () => applyDarkMode(darkModeToggle.checked));

    // ---------------- Sidebar ----------------
    openSidebar.addEventListener('click', () => sidebar.style.transform = 'translateX(0)');
    closeSidebar.addEventListener('click', () => sidebar.style.transform = 'translateX(-100%)');

    // ---------------- Chat Management ----------------
    function saveChats() { localStorage.setItem('chats', JSON.stringify(chats)); }
    function addChat(name = 'New Chat') {
      const chat = { id: Date.now(), name, messages: [] };
      chats.unshift(chat);
      currentChatId = chat.id;
      saveChats();
      renderChatList();
      renderMessages();
    }
    function deleteChat(id) {
      chats = chats.filter(c => c.id !== id);
      if(chats.length) currentChatId = chats[0].id;
      else currentChatId = null;
      saveChats();
      renderChatList();
      renderMessages();
    }
    function renameChat(id, name) {
      const chat = chats.find(c => c.id === id);
      if(chat) chat.name = name;
      saveChats();
      renderChatList();
    }

    function renderChatList() {
      chatList.innerHTML = '';
      chats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
        li.innerHTML = `
          <span>${chat.name}</span>
          <div class="flex space-x-1">
            <button class="renameBtn text-blue-500">‚úé</button>
            <button class="deleteBtn text-red-500">üóë</button>
          </div>
        `;
        li.addEventListener('click', () => { currentChatId = chat.id; renderMessages(); if(window.innerWidth < 768) sidebar.style.transform = 'translateX(-100%)'; });
        li.querySelector('.deleteBtn').addEventListener('click', e => { e.stopPropagation(); deleteChat(chat.id); });
        li.querySelector('.renameBtn').addEventListener('click', e => { e.stopPropagation(); const newName = prompt('New chat name', chat.name); if(newName) renameChat(chat.id, newName); });
        chatList.appendChild(li);
      });
    }

    function renderMessages() {
      chatMessages.innerHTML = '';
      const chat = chats.find(c => c.id === currentChatId);
      if(!chat) return;
      chat.messages.forEach(m => renderMessage(m));
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function renderMessage(msg) {
      const div = document.createElement('div');
      div.className = 'flex';
      div.classList.add(msg.role === 'user' ? 'justify-end' : 'justify-start');
      div.innerHTML = `
        <div class="${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-200'} p-2 rounded max-w-xs whitespace-pre-wrap break-words">
          ${marked.parse(msg.content)}
        </div>
      `;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ---------------- Send Message ----------------
    async function sendMessage() {
      const content = chatInput.value.trim();
      if(!content) return;
      const chat = chats.find(c => c.id === currentChatId);
      if(!chat) return;
      chat.messages.push({ role: 'user', content });
      renderMessage({ role: 'user', content });
      chatInput.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;
      await fetchAIResponse(chat, content);
      saveChats();
    }

    async function fetchAIResponse(chat, promptText) {
      const aiMsg = { role: 'assistant', content: '' };
      chat.messages.push(aiMsg);
      renderMessage(aiMsg);

      try {
        const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model,
            stream: true,
            messages: [
              { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },
              ...chat.messages.filter(m => m.role !== 'assistant')
            ]
          })
        });

        if(!res.body) throw new Error('No response body');

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let done = false;
        while(!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          if(value) {
            const textChunk = decoder.decode(value);
            aiMsg.content += textChunk;
            renderMessages();
          }
        }
      } catch(e) {
        aiMsg.content = '‚ö†Ô∏è Error fetching response. Check API key & network.';
        renderMessages();
        console.error(e);
      }
    }

    // ---------------- Event Listeners ----------------
    newChatBtn.addEventListener('click', () => addChat());
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
    closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
    saveSettings.addEventListener('click', () => {
      apiKey = apiKeyInput.value.trim();
      model = modelInput.value.trim() || 'deepseek/deepseek-r1:free';
      localStorage.setItem('apiKey', apiKey);
      localStorage.setItem('model', model);
      settingsModal.classList.add('hidden');
      alert('Settings saved!');
    });

    // ---------------- Init ----------------
    apiKeyInput.value = apiKey;
    modelInput.value = model;
    renderChatList();
    renderMessages();

    // Hide loader
    loading.style.display = 'none';
  })();
  </script>
</body>
</html>
