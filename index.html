<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Markdown Styles */
        .prose pre { background-color: #1e293b !important; color: #e2e8f0; border-radius: 0.5rem; padding: 1rem; overflow-x: auto; }
        .prose code { color: #ea580c; background-color: rgba(0,0,0,0.05); padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-size: 0.9em; }
        .dark .prose code { color: #fdba74; background-color: rgba(255,255,255,0.1); }
        .prose p { margin-bottom: 0.8rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.8rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.8rem; }
        
        /* Loader */
        #loading { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; font-family: sans-serif; font-weight: 500; color: #475569; transition: opacity 0.5s ease; }
        .dark #loading { background: #0f172a; color: #cbd5e1; }
        
        /* Mobile Safe Area */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-gray-950 dark:text-slate-200 h-full overflow-hidden font-sans selection:bg-blue-200 dark:selection:bg-blue-900">

    <div id="loading">
        <div class="flex flex-col items-center gap-4">
            <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p>Initializing Interface...</p>
        </div>
    </div>

    <div id="app" class="flex h-[100dvh] w-full relative transition-colors duration-300">

        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass transition-opacity" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="absolute md:relative z-30 w-72 h-full bg-gray-100 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-xl md:shadow-none">
            
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex-1 flex items-center gap-2 bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 text-sm font-medium py-3 px-4 rounded-xl transition-colors">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
                <button onclick="toggleSidebar()" class="md:hidden ml-2 p-2 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-list">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800 space-y-2">
                <button onclick="openModal('settings-modal')" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </button>
                <div class="text-xs text-center text-gray-400 pt-2">v1.2.0 â€¢ Zero Build</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full">
            
            <header class="h-16 flex items-center justify-between px-4 sticky top-0 bg-gray-50/90 dark:bg-gray-950/90 backdrop-blur z-10">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="font-semibold text-lg bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent" id="header-model-name">DeepSeek R1</h1>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="toggleSystemPrompt()" class="p-2 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-full" title="System Prompt">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </button>
                    <button onclick="toggleTheme()" class="p-2 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-full" title="Toggle Theme">
                        <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto px-4 pb-4 w-full max-w-4xl mx-auto scroll-smooth">
                <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center p-6 text-gray-500 opacity-60">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mb-4 shadow-lg"></div>
                    <h2 class="text-2xl font-bold mb-2">How can I help you today?</h2>
                    <p class="text-sm">Set your API key in settings to start.</p>
                </div>
                <div id="messages" class="space-y-6 py-4">
                    </div>
                <div id="scroll-anchor" class="h-24"></div> 
            </div>

            <div class="p-4 bg-gray-50 dark:bg-gray-950 safe-bottom">
                <div class="max-w-3xl mx-auto w-full relative">
                    
                    <div id="file-previews" class="flex gap-2 mb-2 overflow-x-auto px-1 hidden"></div>

                    <div class="flex items-end gap-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-3xl px-4 py-3 shadow-sm focus-within:shadow-md focus-within:ring-1 ring-blue-500 transition-all">
                        
                        <button onclick="document.getElementById('file-upload').click()" class="p-2 -ml-2 text-gray-400 hover:text-blue-500 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                        <input type="file" id="file-upload" multiple accept="image/*" class="hidden" onchange="handleFileUpload(event)">

                        <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-0 focus:ring-0 p-2 resize-none max-h-48 text-base outline-none dark:placeholder-gray-500" placeholder="Type a message..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

                        <button id="send-btn" onclick="sendMessage()" class="p-2 -mr-1 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-transform disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-2">AI can make mistakes. Check important info.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
            <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-850">
                <h3 class="font-semibold">Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 ring-blue-500 outline-none" placeholder="sk-or-...">
                    <p class="text-xs text-gray-400 mt-1">Key is stored locally in your browser.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Model ID</label>
                    <input type="text" id="model-input" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 ring-blue-500 outline-none" value="deepseek/deepseek-r1:free">
                    <div class="flex gap-2 mt-2">
                        <button onclick="setModel('deepseek/deepseek-r1:free')" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900">DeepSeek Free</button>
                        <button onclick="setModel('google/gemini-2.0-flash-exp:free')" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900">Gemini 2.0 Free</button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-800 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="system-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-full max-w-lg rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
                <h3 class="font-semibold">System Prompt</h3>
                <button onclick="closeModal('system-modal')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            </div>
            <div class="p-4 flex-1">
                <textarea id="system-prompt-input" class="w-full h-48 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-3 text-sm focus:ring-2 ring-blue-500 outline-none resize-none" placeholder="You are a helpful AI assistant..."></textarea>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-800 flex justify-end gap-2">
                <button onclick="saveSystemPrompt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Save Prompt</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. STATE MANAGEMENT ---
        const state = {
            chats: [],
            currentChatId: null,
            apiKey: '',
            model: 'deepseek/deepseek-r1:free',
            systemPrompt: '',
            darkMode: false,
            sidebarOpen: false,
            pendingImages: [] // Store base64 images waiting to be sent
        };

        const dom = {
            app: document.getElementById('app'),
            loading: document.getElementById('loading'),
            chatList: document.getElementById('chat-list'),
            messages: document.getElementById('messages'),
            userInput: document.getElementById('user-input'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay'),
            headerModel: document.getElementById('header-model-name'),
            welcome: document.getElementById('welcome-message'),
            filePreviews: document.getElementById('file-previews'),
            sendBtn: document.getElementById('send-btn')
        };

        // --- 2. INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            initUI();
            
            // Artificial delay to prevent FOUC (Flash of Unstyled Content)
            setTimeout(() => {
                dom.loading.style.opacity = '0';
                setTimeout(() => dom.loading.remove(), 500);
            }, 300);
        });

        function loadFromStorage() {
            state.apiKey = localStorage.getItem('or_api_key') || '';
            state.model = localStorage.getItem('or_model') || 'deepseek/deepseek-r1:free';
            state.systemPrompt = localStorage.getItem('or_system_prompt') || '';
            state.darkMode = localStorage.getItem('or_dark_mode') === 'true';
            
            const savedChats = localStorage.getItem('or_chats');
            state.chats = savedChats ? JSON.parse(savedChats) : [];
            
            // Load inputs in settings modal
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            
            // Set Model Header
            updateModelHeader();
        }

        function initUI() {
            // Apply Theme
            if (state.darkMode) document.documentElement.classList.add('dark');
            
            // Render Chats
            renderChatList();
            
            // If no chats, create new id without saving yet (waiting for first message)
            if (state.chats.length === 0) {
                createNewChat(false);
            } else {
                // Load most recent
                loadChat(state.chats[0].id);
            }

            // Init Markdown highlight
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-'
            });
        }

        // --- 3. THEME & UI ACTIONS ---
        function toggleTheme() {
            state.darkMode = !state.darkMode;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('or_dark_mode', state.darkMode);
        }

        function toggleSidebar() {
            state.sidebarOpen = !state.sidebarOpen;
            if (state.sidebarOpen) {
                dom.sidebar.classList.remove('-translate-x-full');
                dom.overlay.classList.remove('hidden');
            } else {
                dom.sidebar.classList.add('-translate-x-full');
                dom.overlay.classList.add('hidden');
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function toggleSystemPrompt() {
            openModal('system-modal');
        }

        function setModel(modelName) {
            document.getElementById('model-input').value = modelName;
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const mod = document.getElementById('model-input').value.trim();
            
            state.apiKey = key;
            state.model = mod;
            
            localStorage.setItem('or_api_key', key);
            localStorage.setItem('or_model', mod);
            
            updateModelHeader();
            closeModal('settings-modal');
            alert('Settings Saved!');
        }

        function saveSystemPrompt() {
            const prompt = document.getElementById('system-prompt-input').value.trim();
            state.systemPrompt = prompt;
            localStorage.setItem('or_system_prompt', prompt);
            closeModal('system-modal');
        }

        function updateModelHeader() {
            // Simple cleanup of model name for display
            const name = state.model.split('/')[1] || state.model;
            dom.headerModel.textContent = name.replace(/:free$/, '').replace(/-/g, ' ').toUpperCase();
        }

        // --- 4. CHAT LOGIC ---
        function createNewChat(shouldRender = true) {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: [],
        
